buildscript {
    ext.kotlinVersion = '1.3.72'
    repositories {
        google()
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:4.0.1'
        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.8.5'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion"
        classpath "org.jetbrains.kotlin:kotlin-serialization:$kotlinVersion"
    }
}

allprojects {
    repositories {
        google()
        jcenter()
        flatDir { dirs 'libs' }
        maven { url 'https://dl.bintray.com/enrevol/ee-x' }
        maven { url 'https://dl.bintray.com/ironsource-mobile/android-adapters' }
        maven { url 'https://dl.bintray.com/ironsource-mobile/android-sdk' }
    }
}

ext {
    compileSdkVersion = 30
    buildToolsVersion = '30.0.1'
    targetSdkVersion = 30
    buildPrefab = true
    buildMaven = true
}

def applyPrefabSettings(project, String libraryName, headerPaths) {
    /*
    Wait for AndroidStudio4.1
    
    def projectDir = project.projectDir
    project.android {
        ndkVersion '21.3.6528147'

        buildFeatures {
            prefabPublishing true
        }

        externalNativeBuild {
            cmake {
                path "$projectDir/CMakeLists.txt"
            }
        }

        prefab {
            "$libraryName" {
                headers "$projectDir/.generated_headers"
            }
        }
    }

    project.preBuild.dependsOn(tasks.create(name: "${libraryName}CopyHeaders") {
        doFirst {
            delete {
                delete "$projectDir/.generated_headers"
            }
            copy {
                from '../src'
                into "$projectDir/.generated_headers"
                headerPaths.each { item ->
                    include item
                }
            }
        }
    })
     */
}


def publishToMaven(String libraryName, String libraryVersion) {
    project("ee-x-$libraryName") {
        apply plugin: 'com.jfrog.bintray'
        apply plugin: 'maven-publish'
        task androidSourcesJar(type: Jar) {
            from android.sourceSets.main.java.srcDirs
            archiveClassifier.set('sources')
        }
        afterEvaluate {
            publishing {
                publications {
                    create(libraryName, MavenPublication) {
                        from project.components.release
                        artifact androidSourcesJar
                        groupId = 'com.senspark.ee'
                        artifactId = libraryName
                        version = libraryVersion
                    }
                }
                repositories {
                    maven {
                        url "$buildDir/repo"
                    }
                }
            }
            bintray {
                user = "${BINTRAY_USER}"
                key = "${BINTRAY_API_KEY}"
                override = true
                publications = [libraryName]
                pkg {
                    repo = 'ee-x'
                    name = libraryName
                    licenses = ['MIT']
                    publish = true
                    vcsUrl = 'https://github.com/Senspark/ee-x.git'
                    version {
                        name = libraryVersion
                    }
                }
            }
        }
    }
}